<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<th:block layout:fragment="css"></th:block>
<div layout:fragment="content">
  <div th:class="container-lg">

      <div class="py-5 px-4">
      <!--ê½ƒ ì´ë¦„-->
      <h2 class="pb-3 border-bottom">ğŸ¤— ì˜¤ëŠ˜ì˜ ê½ƒì€ <strong class="todayFlowerName" th:text="${form.name}"></strong>ì…ë‹ˆë‹¤.<br />
        <strong th:text="${form.name}"></strong>ì˜ ê½ƒë§ì€ <strong th:text="${form.flowerLang}"></strong> ì…ë‹ˆë‹¤.
      </h2>

      <!-- ì¡°íšŒìˆ˜ -->
      <div class="py-4 mb-3">
        <div th:text="|ì¡°íšŒìˆ˜: ${form.hits}|"></div>
      </div>

      <!-- ìºëŸ¬ì…€ ì´ë¯¸ì§€ -->
      <div id="carouselExampleIndicators" class="carousel slide w-78 mx-auto text-center py-4 pb-3" data-bs-ride="true">
        <div class="carousel-indicators">
          <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
          <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
          <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
        </div>
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img th:src="${form.photoPath[0]}" class="img-fluid" alt="...">
          </div>
          <div class="carousel-item">
            <img th:src="${form.photoPath[1]}" class="img-fluid" alt="...">
          </div>
          <div class="carousel-item">
            <img th:src="${form.photoPath[2]}" class="img-fluid" alt="...">
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>

      <div class="py-4">
        <!-- ì¢‹ì•„ìš” ë²„íŠ¼-->
        <div class="float-end">
          <button sec:authorize="isAuthenticated()" type="button" class="btn btn-outline-danger btn-like"
                  th:data-flower-id="${form.flowerId}"
                  th:data-like="${form.like}">
            <i th:classappend="${form.like} ? 'bi bi-heart-fill' : 'bi bi-heart'"></i>
<!--              <input type="hidden" id="flower_id" th:field="${form.flowerId}">-->
<!--              <input type="hidden" id="like" th:field="${form.like}">-->
<!--              <input type="hidden" formaction="/flower/like" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">-->
          </button>

            <script>
                $(document).ready(function() {
                    // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì‹œ
                    $('.btn-like').on('click', function() {
                        var btn = $(this);
                        var flowerId = btn.data('flower-id');
                        //var userId = ; // ì‚¬ìš©ì IDë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
                        var like = btn.data('like');
                        var header = $("meta[name='_csrf_header']").attr("content");
                        var csrfToken = $("meta[name='_csrf']").attr("content"); // CSRF í† í°ì„ ì—¬ê¸°ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.

                        console.log(flowerId+", "+like);

                        // Ajax ìš”ì²­ ì „ì†¡
                        $.ajax({
                            type: "POST",
                            async: true, //ë¹„ë™ê¸° ì—¬ë¶€
                            url: "/flower/like",
                            dataType: "json",
                            contentType: "application/json;charset=utf-8",
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader(header, csrfToken)
                            },
                            data: JSON.stringify({
                                "like": like,
                                "flower_id": flowerId,
                                "_csrf": csrfToken
                            }),
                            success: function(response) {
                                // ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
                                // btn.html('<i class="bi bi-heart-fill"></i>')
                                console.log(response)
                            },
                            error: function(jqXHR, textStatus, errorThrown) {
                                console.log(textStatus, errorThrown);
                            }
                        });
                    });
                });
            </script>

        </div>
      </div>

      <!-- ì „ì²´ ì¢‹ì•„ìš” ìˆ˜ -->
        <div class="py-4">
          <span class="float-end" th:text="|ì¢‹ì•„ìš” ${form.totalLike}ê°œ|"></span>
        </div>

      <!-- ì„¤ëª… -->
      <h2 class="pb-3 border-bottom">ğŸ’¬ ì´ì•¼ê¸°</h2>
      <div class="py-4 mb-3">
          <span th:text="${form.description}"></span>
      </div>

    </div>
  </div>
</div>
</html>