<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<th:block layout:fragment="css"></th:block>
<div layout:fragment="content">
  <div th:class="container">

          <div class="py-5 px-4">
              <div class="is-valid" >
                  <div th:if="${error}" th:text="${error}"></div>
              </div>
              <div th:unless="${error}">
                  <!--ê½ƒ ì´ë¦„-->
                  <h2 class="pb-3 border-bottom">ğŸ¤— ì˜¤ëŠ˜ì˜ ê½ƒì€ <strong style="color: tomato; font-size: 29px" class="todayFlowerName" th:text="${form.name}"></strong>ì…ë‹ˆë‹¤.<br />
                      <strong style="color: tomato; font-size: 29px" th:text="${form.name}"></strong>ì˜ ê½ƒë§ì€ <strong style="color: dodgerblue; font-size: 29px" th:text="${form.flowerLang}"></strong> ì…ë‹ˆë‹¤.
                  </h2>

                  <!-- ì¡°íšŒìˆ˜ -->
                  <div class="py-4 mb-1">
                      <div th:text="|ğŸ‘€ ì¡°íšŒìˆ˜: ${form.hits}|"></div>
                  </div>

                  <!-- ìºëŸ¬ì…€ ì´ë¯¸ì§€ -->
                  <div id="carouselExampleIndicators" class="carousel slide mx-auto text-center py-4 pb-3" style="width: 80%" data-bs-ride="true" data-bs-touch="false">
                      <div class="carousel-indicators">
                          <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                          <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
                          <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
                      </div>
                      <div class="carousel-inner" style="border-radius: 5px">
                          <div class="carousel-item active">
                              <img th:src="${form.photoPath[0]}" class="img-fluid" alt="...">
                          </div>
                          <div class="carousel-item">
                              <img th:src="${form.photoPath[1]}" class="img-fluid" alt="...">
                          </div>
                          <div class="carousel-item">
                              <img th:src="${form.photoPath[2]}" class="img-fluid" alt="...">
                          </div>
                      </div>
                      <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                          <span class="visually-hidden">Previous</span>
                      </button>
                      <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                          <span class="carousel-control-next-icon" aria-hidden="true"></span>
                          <span class="visually-hidden">Next</span>
                      </button>
                  </div>

                  <div class="py-4">
                      <!-- ì¢‹ì•„ìš” ë²„íŠ¼ ë¹„íšŒì›-->
                      <div class="float-end">
                          <button type="button" sec:authorize="!isAuthenticated()" class="btn btn-outline-danger btn-like" disabled
                                  th:data-flower-id="${form.flowerId}"
                                  th:data-like="${form.like}">
                            <span th:classappend="${form.like} ? 'bi bi-heart-fill' : 'bi bi-heart'">
                                <!-- ì „ì²´ ì¢‹ì•„ìš” ìˆ˜ -->
                                <span class="float-end" th:text="|&nbsp;ì¢‹ì•„ìš” ${form.totalLike}ê°œ|"></span>
                            </span>
                          </button>

                          <!-- ì¢‹ì•„ìš” ë²„íŠ¼ íšŒì›-->
                          <button type="button" sec:authorize="isAuthenticated()" class="btn btn-outline-danger btn-like"
                                  th:data-flower-id="${form.flowerId}"
                                  th:data-like="${form.like}">
                            <span id="like-heart" th:classappend="${form.like} ? 'bi bi-heart-fill' : 'bi bi-heart'">
                                  <!-- ì „ì²´ ì¢‹ì•„ìš” ìˆ˜ -->
                                  <span id="totalLikeSpan" class="float-end" th:text="|&nbsp;ì¢‹ì•„ìš” ${form.totalLike}ê°œ|"></span>
                            </span>
                          </button>

                          <script>
                              $(document).ready(function() {
                                  // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì‹œ
                                  $('.btn-like').on('click', function() {
                                      var btn = $(this);
                                      var flowerId = btn.data('flower-id');
                                      var like = btn.data('like');
                                      var header = $("meta[name='_csrf_header']").attr("content");
                                      var csrfToken = $("meta[name='_csrf']").attr("content"); // CSRF í† í°ì„ ì—¬ê¸°ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.

                                      // Ajax ìš”ì²­ ì „ì†¡
                                      $.ajax({
                                          type: "POST",
                                          async: true, //ë¹„ë™ê¸° ì—¬ë¶€
                                          url: "/flower/like",
                                          dataType: "json",
                                          contentType: "application/json;charset=utf-8",
                                          // csrf ì „ì†¡
                                          beforeSend: function (xhr) {
                                              xhr.setRequestHeader(header, csrfToken)
                                          },
                                          data: JSON.stringify({
                                              "like": like,
                                              "flower_id": flowerId
                                          }),
                                          success: function(response) {
                                              // ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
                                              let resTotalLike = response.total_like_count;
                                              let resLike = response.like;

                                              $('#totalLikeSpan').html("&nbsp;ì¢‹ì•„ìš” "+resTotalLike+"ê°œ");
                                              btn.data('like', resLike);

                                              if(resLike) {
                                                  $('#like-heart').removeClass('bi bi-heart').addClass('bi bi-heart-fill');
                                              } else {
                                                  $('#like-heart').removeClass('bi bi-heart-fill').addClass('bi bi-heart');
                                              }

                                          },
                                          error: function(jqXHR, textStatus, errorThrown) {
                                              console.log(textStatus, errorThrown);
                                          }
                                      });
                                  });
                              });
                          </script>

                      </div>
                  </div>

                  <div class="py-4 pb-3">
                      <a href="/user/signup" style="text-decoration: none; color: black">
                          <div sec:authorize="!isAuthenticated()" class="float-end">
                              <strong>ğŸ‘‰ íšŒì›ê°€ì…</strong><span>í•˜ê³  â¤ï¸ ì¢‹ì•„ìš” ëˆ„ë¥´ê¸°</span>
                          </div>
                      </a>
                  </div>

                  <!-- ì„¤ëª… -->
                  <h2 class="py-4 pb-3 border-bottom">ğŸ’¬ ì´ì•¼ê¸°</h2>
                  <div class="py-4 mb-3">
                      <span th:text="${form.description}"></span>
                  </div>

              </div>
          </div>
  </div>
</div>
</html>